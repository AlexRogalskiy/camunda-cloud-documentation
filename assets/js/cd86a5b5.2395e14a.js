(self.webpackChunkcamunda_cloud_documentation=self.webpackChunkcamunda_cloud_documentation||[]).push([[60916],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return u},kt:function(){return m}});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=p(n),m=i,h=d["".concat(l,".").concat(m)]||d[m]||c[m]||o;return n?a.createElement(h,r(r({ref:t},u),{},{components:n})):a.createElement(h,r({ref:t},u))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var p=2;p<o;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},92771:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return r},contentTitle:function(){return s},metadata:function(){return l},toc:function(){return p},default:function(){return c}});var a=n(22122),i=n(19756),o=(n(67294),n(3905)),r={id:"tutorial",title:"Tutorial",description:"Let's implement an application using the Tasklist API"},s="How to build an application using the Tasklist API and NestJS",l={unversionedId:"components/tasklist/userguide/api/tutorial",id:"components/tasklist/userguide/api/tutorial",isDocsHomePage:!1,title:"Tutorial",description:"Let's implement an application using the Tasklist API",source:"@site/docs/components/tasklist/userguide/api/tutorial.md",sourceDirName:"components/tasklist/userguide/api",slug:"/components/tasklist/userguide/api/tutorial",permalink:"/docs/components/tasklist/userguide/api/tutorial",editUrl:"https://github.com/camunda-cloud/camunda-cloud-documentation/edit/master/docs/components/tasklist/userguide/api/tutorial.md",version:"current",frontMatter:{id:"tutorial",title:"Tutorial",description:"Let's implement an application using the Tasklist API"},sidebar:"Components",previous:{title:"Overview",permalink:"/docs/components/tasklist/userguide/api/overview"},next:{title:"Overview and example use case",permalink:"/docs/components/tasklist/userguide/user-interface/overview"}},p=[{value:"Getting started",id:"getting-started",children:[]},{value:"Before we go ahead",id:"before-we-go-ahead",children:[]},{value:"Creating a new NestJS application",id:"creating-a-new-nestjs-application",children:[]},{value:"Generating the Tasklist service",id:"generating-the-tasklist-service",children:[]},{value:"Handling the Tasklist API authentication",id:"handling-the-tasklist-api-authentication",children:[]},{value:"Creating your application API",id:"creating-your-application-api",children:[]},{value:"Demo data generation and sample frontend",id:"demo-data-generation-and-sample-frontend",children:[]}],u={toc:p};function c(e){var t=e.components,n=(0,i.Z)(e,["components"]);return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"how-to-build-an-application-using-the-tasklist-api-and-nestjs"},"How to build an application using the Tasklist API and NestJS"),(0,o.kt)("p",null,"The Tasklist API provides a simple way for you to build apps powered by BPMN that require human interaction.\nOn this example we'll use NestJS, one of the most popular Node.js backend frameworks to a build a loan request review application."),(0,o.kt)("h2",{id:"getting-started"},"Getting started"),(0,o.kt)("p",null,"To do this tutorial we'll need:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Node v14+"),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("a",{parentName:"li",href:"https://docs.nestjs.com/cli/overview"},"NestJS CLI")," tool. You can install it by running ",(0,o.kt)("inlineCode",{parentName:"li"},"npm install -g @nestjs/cli")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"../../../../cloud-console/manage-clusters/create-cluster"},"A cluster on Camunda Cloud")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"../../../../cloud-console/manage-clusters/manage-api-clients"},"A set of API credentials, remember to check the Tasklist option when creating them.")," Don't forget to save these, we'll need them later."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/camunda-community-hub/camunda-cloud-tasklist-api-nestjs"},"To clone this repo"))),(0,o.kt)("h2",{id:"before-we-go-ahead"},"Before we go ahead"),(0,o.kt)("p",null,"If you followed the steps on the Getting started section you should have cloned a repo with the complete demo application we're going to build over this tutorial. The default branch in this repo has the complete application, so we need to checkout to the branch ",(0,o.kt)("inlineCode",{parentName:"p"},"0-getting-started")," before proceeding."),(0,o.kt)("p",null,"Inside the repo folder you'll find some files and 2 folders, one of these folders is called ",(0,o.kt)("inlineCode",{parentName:"p"},"demo-data/")," and the other ",(0,o.kt)("inlineCode",{parentName:"p"},"frontend/"),". As it might be evident inside of each of these folders there are 2 different projects. The former will be responsible by deploying the demo process into Zeebe and generating instances for that process. The later is a frontend application that will consume our API, this project is boostrapped with ",(0,o.kt)("a",{parentName:"p",href:"https://vitejs.dev"},"Vite"),", ",(0,o.kt)("a",{parentName:"p",href:"https://bulma.io"},"bulma")," for styling and ",(0,o.kt)("a",{parentName:"p",href:"https://react-query.tanstack.com"},"react-query")),(0,o.kt)("h2",{id:"creating-a-new-nestjs-application"},"Creating a new NestJS application"),(0,o.kt)("p",null,"Now let's bootstrap our NestJS app, to do that:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Open your terminal and go to the cloned repository folder"),(0,o.kt)("li",{parentName:"ul"},"Run ",(0,o.kt)("inlineCode",{parentName:"li"},"nest new api")),(0,o.kt)("li",{parentName:"ul"},"Pick ",(0,o.kt)("inlineCode",{parentName:"li"},"yarn")," as a package manager")),(0,o.kt)("p",null,"This will create the NestJS project for us inside the ",(0,o.kt)("inlineCode",{parentName:"p"},"api/")," folder, we can clean up the project a bit and remove the files ",(0,o.kt)("inlineCode",{parentName:"p"},"api/app.controller.spec.ts"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"api/app.controller.ts")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"api/app.service.ts"),".\nWe can also remove the references from the deleted files in ",(0,o.kt)("inlineCode",{parentName:"p"},"api/app.module.ts"),", the file should look like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'import { Module } from "@nestjs/common";\n\n@Module({\n  imports: [],\n  controllers: [],\n  providers: [],\n})\nexport class AppModule {}\n')),(0,o.kt)("p",null,"To check if everything is working as expected you can run ",(0,o.kt)("inlineCode",{parentName:"p"},"yarn workspace api run start:dev")," from the root folder on your terminal. You should see a message similar like the one below:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"[00:00:00 AM] Starting compilation in watch mode...\n[00:00:00 AM] Found 0 errors. Watching for file changes.\n[Nest] 46621  - 00/00/0000, 00:00:00 AM     LOG [NestFactory] Starting Nest application...\n[Nest] 46621  - 00/00/0000, 00:00:00 AM     LOG [InstanceLoader] AppModule dependencies initialized +12ms\n[Nest] 46621  - 00/00/0000, 00:00:00 AM     LOG [NestApplication] Nest application successfully started +3ms\n")),(0,o.kt)("h2",{id:"generating-the-tasklist-service"},"Generating the Tasklist service"),(0,o.kt)("p",null,"Now inside the ",(0,o.kt)("inlineCode",{parentName:"p"},"api/")," folder we'll need to generate a service that will be responsible for accessing the Tasklist API. To do that:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Run ",(0,o.kt)("inlineCode",{parentName:"li"},"nest g service")),(0,o.kt)("li",{parentName:"ul"},"You'll be prompted to pick a name for the service, let's pick ",(0,o.kt)("inlineCode",{parentName:"li"},"tasklist")),(0,o.kt)("li",{parentName:"ul"},"Run ",(0,o.kt)("inlineCode",{parentName:"li"},"yarn add @nestjs/axios"))),(0,o.kt)("p",null,"A folder called ",(0,o.kt)("inlineCode",{parentName:"p"},"tasklist/")," will be created with the service definition and test, again you can delete the tests if you wish. We also installed the package ",(0,o.kt)("inlineCode",{parentName:"p"},"@nestjs/axios")," so we can make requests to the Tasklist API.\nTo use make HTTP requests we need to inject the module into the service, like below:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'import { Injectable } from "@nestjs/common";\nimport { HttpService } from "@nestjs/axios";\n\n@Injectable()\nexport class TasklistService {\n  constructor(private readonly http: HttpService) {}\n}\n')),(0,o.kt)("p",null,"Now were ready to make requests to the API, but first let's define a Data Transfer Object, or DTO, with the shape of the tasks were going to request. For that we can create a file in ",(0,o.kt)("inlineCode",{parentName:"p"},"tasklist/dto/task.dto.ts"),". There we can define the DTO like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"type Variable = {\n  name: string;\n  value: string;\n};\n\nexport class TaskDto {\n  id: string;\n  name: string;\n  processName: string;\n  creationTime: string;\n  completionTime: string | null;\n  assignee: string | null;\n  variables: Variable[];\n  taskState: 'CREATED' | 'COMPLETED' | 'CANCELED';\n  sortValues: [string, string];\n  isFirst: boolean | null;\n  formKey: string | null;\n  processDefinitionId: string;\n  taskDefinitionId: string;\n}\n")),(0,o.kt)("p",null,"We can implement the requests, for that we need to define the Tasklist API query and define the methods on the service:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'import { HttpService } from "@nestjs/axios";\nimport { Injectable } from "@nestjs/common";\nimport { firstValueFrom } from "rxjs";\nimport { TaskDto } from "./dto/task.dto";\n\nconst getTasksQuery = `\n  query GetTasks($state: TaskState $pageSize: Int $searchAfter: [String!] $searchBefore: [String!] $taskDefinitionId: String!) {\n    tasks(query: { state: $state pageSize: $pageSize searchAfter: $searchAfter searchBefore: $searchBefore taskDefinitionId: $taskDefinitionId }) {\n      id\n      creationTime\n      variables {\n        value\n        name\n      }\n      taskState\n      isFirst\n      sortValues\n    }\n  }\n`;\n\ntype QueryVariables = {\n  pageSize?: number;\n  searchAfter?: [string, string];\n  searchBefore?: [string, string];\n  state?: "CREATED" | "COMPLETED";\n  taskDefinitionId?: string;\n};\n\n@Injectable()\nexport class TasklistService {\n  constructor(private readonly http: HttpService) {}\n\n  async getTasks(variables: QueryVariables): Promise<TaskDto[]> {\n    const { http } = this;\n    const { errors, data } = (\n      await firstValueFrom(\n        http.post("/", {\n          /*\n           for simplicity we just used Axios here, but since the Tasklist API is a GraphQL API\n           a package like `graphql-request` might be better suited for this\n          */\n          query: getTasksQuery,\n          variables,\n        })\n      )\n    ).data;\n\n    if (errors) {\n      // handle error\n    }\n\n    return data.tasks;\n  }\n}\n')),(0,o.kt)("p",null,"For the sake of brevity we only have one query and one method here, to see the complete implementation you can check this ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/camunda-community-hub/camunda-cloud-tasklist-api-nestjs/blob/2-generating-tasklist-service/api/src/tasklist/tasklist.service.ts"},"file")),(0,o.kt)("h2",{id:"handling-the-tasklist-api-authentication"},"Handling the Tasklist API authentication"),(0,o.kt)("p",null,"We have the implementation of our service, but we still can't make requests to the Tasklist API because we're not providing any credentials to the API.\nTo achieve this we need to rename the file ",(0,o.kt)("inlineCode",{parentName:"p"},".env.example")," to ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," (the file needs to be on the root because we'll reuse it to generate the demo data), and the content of this file should look like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'ZEEBE_ADDRESS="<cluster-id>.bru-2.zeebe.camunda.io:443"\nZEEBE_CLIENT_ID="k2FKt_PNMrRUFQO-QOR9MtCygvGsT.sm"\nZEEBE_CLIENT_SECRET="C-o5WFhvoZKv4-oQGHWg~d2MObjdr-GUv3cdqRS3~6fCoHaLleEEwnOqRToQvWda"\nZEEBE_AUTHORIZATION_SERVER_URL="https://login.cloud.camunda.io/oauth/token"\nTASKLIST_API_ADDRESS="https://bru-2.tasklist.camunda.io/<cluster-id>/graphql"\nZEEBE_AUTHORIZATION_AUDIENCE="tasklist.camunda.io"\n')),(0,o.kt)("p",null,"You can find all this information on the tab ",(0,o.kt)("inlineCode",{parentName:"p"},"API")," in our cluster page, the client id and secret should be on the file you downloaded on the Getting started section.\nNow we have our credentials we can authenticate and inject the JWT token into every request we make into Tasklist API.\nFor that we need to turn our tasklist service into part of a module, run ",(0,o.kt)("inlineCode",{parentName:"p"},"nest g module")," and name it ",(0,o.kt)("inlineCode",{parentName:"p"},"tasklist"),", the same we named the service. This will generate the module file and update ",(0,o.kt)("inlineCode",{parentName:"p"},"app.module.ts"),".\nWe need to edit the ",(0,o.kt)("inlineCode",{parentName:"p"},"app.module.ts")," file to use only the module:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'import { Module } from "@nestjs/common";\nimport { TasklistModule } from "./tasklist/tasklist.module";\n\n@Module({\n  imports: [TasklistModule],\n  controllers: [],\n  providers: [],\n})\nexport class AppModule {}\n')),(0,o.kt)("p",null,"We can install the package ",(0,o.kt)("inlineCode",{parentName:"p"},"@nestjs/config")," and finally implement the authentication:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'import { Logger, Module, OnModuleInit } from "@nestjs/common";\nimport { ConfigModule, ConfigService } from "@nestjs/config";\nimport { HttpModule, HttpService } from "@nestjs/axios";\nimport { TasklistService } from "./tasklist.service";\nimport { firstValueFrom, map } from "rxjs";\n\ntype AuthResponse = {\n  access_token: string;\n  scope: string;\n  expires_in: number;\n  token_type: string;\n};\n\n@Module({\n  imports: [\n    HttpModule,\n    ConfigModule.forRoot({\n      envFilePath: "../.env",\n    }),\n  ],\n  providers: [TasklistService],\n  exports: [TasklistService, HttpModule, ConfigModule],\n})\nexport class TasklistModule implements OnModuleInit {\n  logger = new Logger(TasklistModule.name);\n\n  constructor(\n    private readonly http: HttpService,\n    private readonly config: ConfigService\n  ) {}\n\n  public async onModuleInit() {\n    const {\n      http: { axiosRef },\n      config,\n      logger,\n    } = this;\n    const credentials = await this.fetchCredentials();\n\n    logger.log("Tasklist credentials fetched");\n\n    axiosRef.defaults.baseURL = config.get("TASKLIST_API_ADDRESS");\n    axiosRef.defaults.headers[\n      "Authorization"\n    ] = `Bearer ${credentials.access_token}`;\n    axiosRef.defaults.headers["Content-Type"] = "application/json";\n    setTimeout(this.onModuleInit.bind(this), credentials.expires_in * 1000); // we need convert minutes to milliseconds\n  }\n\n  private async fetchCredentials() {\n    const { http, config } = this;\n\n    return firstValueFrom(\n      http\n        .post<AuthResponse>(config.get("ZEEBE_AUTHORIZATION_SERVER_URL"), {\n          client_id: config.get("ZEEBE_CLIENT_ID"),\n          client_secret: config.get("ZEEBE_CLIENT_SECRET"),\n          audience: config.get("ZEEBE_AUTHORIZATION_AUDIENCE"),\n          grant_type: "client_credentials",\n        })\n        .pipe(map((response) => response.data))\n    );\n  }\n}\n')),(0,o.kt)("p",null,"This will make that when this module is initialised we read the credentials using the ",(0,o.kt)("inlineCode",{parentName:"p"},"@nestjs/config")," package, authenticate into the API and inject the JWT into Axios. We also set a timeout to request a new token when the first one expires."),(0,o.kt)("h2",{id:"creating-your-application-api"},"Creating your application API"),(0,o.kt)("p",null,"Now we're able to implement our actual business logic, but first we need to install some packages to create our custom GraphQL API. Run ",(0,o.kt)("inlineCode",{parentName:"p"},"yarn add @nestjs/graphql graphql apollo-server-express"),".\nWe'll have to generate a module, a service and a resource. To achieve that run the following commands:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"nest g module\nnest g service\nnest g resource\n")),(0,o.kt)("p",null,"Use the name ",(0,o.kt)("inlineCode",{parentName:"p"},"loanRequests")," for all options. For the resource generation select the option ",(0,o.kt)("inlineCode",{parentName:"p"},"GraphQL (code first)")," and you don't have to generate the CRUD entrypoints."),(0,o.kt)("p",null,"We can now change our ",(0,o.kt)("inlineCode",{parentName:"p"},"app.module.ts")," file to its final form:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'import { Module } from "@nestjs/common";\nimport { GraphQLModule } from "@nestjs/graphql";\nimport { LoanRequestsModule } from "./loan-requests/loan-requests.module";\n\n@Module({\n  imports: [\n    GraphQLModule.forRoot({\n      autoSchemaFile: true,\n      playground: true,\n    }),\n    LoanRequestsModule,\n  ],\n})\nexport class AppModule {}\n')),(0,o.kt)("p",null,"And the ",(0,o.kt)("inlineCode",{parentName:"p"},"loan-requests/loan-requests.module.ts")," to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'import { Module } from "@nestjs/common";\nimport { LoanRequestsService } from "./loan-requests.service";\nimport { TasklistModule } from "src/tasklist/tasklist.module";\nimport { LoanRequestsResolver } from "./loan-requests.resolver";\n\n@Module({\n  imports: [TasklistModule],\n  providers: [LoanRequestsResolver, LoanRequestsService],\n  exports: [LoanRequestsService, TasklistModule],\n})\nexport class LoanRequestsModule {}\n')),(0,o.kt)("p",null,"We just need to implement the service, which will have 3 methods (1 to get all requests, 1 to get a single request and 1 to make a decision) and the 4 resolvers for the GraphQL API (2 mutations and 2 queries). You can find the full implementation ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/camunda-community-hub/camunda-cloud-tasklist-api-nestjs/tree/4-application/api/src/loan-requests"},"here"),"."),(0,o.kt)("p",null,"You can run ",(0,o.kt)("inlineCode",{parentName:"p"},"yarn start:dev")," inside the ",(0,o.kt)("inlineCode",{parentName:"p"},"api/")," folder and the NestJS app should start without errors.\nTo test your API you can access ",(0,o.kt)("inlineCode",{parentName:"p"},"localhost:3000/graphl")," on your browser and should see our custom GraphQL API playground."),(0,o.kt)("h2",{id:"demo-data-generation-and-sample-frontend"},"Demo data generation and sample frontend"),(0,o.kt)("p",null,"To test our app with the a real frontend we can change the port inside ",(0,o.kt)("inlineCode",{parentName:"p"},"api/main.ts")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"6000"),". And then run from the root folder ",(0,o.kt)("inlineCode",{parentName:"p"},"yarn start:demo-data")," to start the backend, frontend and demo data generation or just ",(0,o.kt)("inlineCode",{parentName:"p"},"yarn start")," if you don't need any new data."))}c.isMDXComponent=!0}}]);